name: Test atb files

on:
  push:
    branches: [main]
  pull_request:
env:
  BUILD_TYPE: Release
  PARALLEL_JOBS: 16

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Pull submodules
        run: git submodule update --init --recursive
      - name: Configure CMake
        run: cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build ${{ github.workspace }}/build --config ${{ env.BUILD_TYPE }}
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download built binary
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./build
    - name: Download atb files
      run: |
        curl -L -o atb_files.tar.xz https://github.com/EltyDev/atb-tools/releases/download/ci-test/atb_files.tar.xz
        tar -xJf atb_files.tar.xz
    - name: Run tests in parallel
      id: run-tests
      continue-on-error: true
      run: |
        chmod +x ./build/bin/atb-tools
        
        cat > test_single_file.sh << 'EOF'
        #!/bin/bash
        file="$1"
        file_basename=$(basename "$file")
        output_file="${file%.atb}_test.atb"
        
        pid=$$
        log_file="/tmp/test_log_${pid}.txt"
        result_file="/tmp/test_result_${pid}.txt"
        
        {
          echo "::group::Testing $file_basename"
          
          ./build/bin/atb-tools test "$file"
          ret=$?
          
          if [ $ret -ne 0 ]; then
            echo "❌ Program failed for $file_basename"
            echo "failed:program_failed:$file_basename" > "$result_file"
          elif [ ! -f "$output_file" ]; then
            echo "❌ Output file missing for $file_basename"
            echo "failed:output_missing:$file_basename" > "$result_file"
          elif ! diff "$file" "$output_file" > /dev/null 2>&1; then
            echo "❌ Differences found for $file_basename"
            echo "failed:differences_found:$file_basename" > "$result_file"
          else
            echo "✅ $file_basename passed"
            echo "passed:::$file_basename" > "$result_file"
          fi
          
          echo "::endgroup::"
        } > "$log_file"
        
        cat "$log_file"
        rm -f "$log_file"
        EOF
        
        chmod +x test_single_file.sh
        
        > /tmp/all_test_results
        
        find . -name "*.atb" -type f | xargs -P ${{ env.PARALLEL_JOBS }} -I {} bash -c './test_single_file.sh "{}"'
        
        for result_file in /tmp/test_result_*.txt; do
          if [ -f "$result_file" ]; then
            cat "$result_file" >> /tmp/all_test_results
            rm -f "$result_file"
          fi
        done
        
        if [ ! -s /tmp/all_test_results ]; then
          echo "ERROR: No test results found!"
          echo "test_failed=true" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        passed_count=$(grep -c "^passed" /tmp/all_test_results 2>/dev/null || echo 0)
        failed_count=$(grep -c "^failed" /tmp/all_test_results 2>/dev/null || echo 0)
        total_count=$((passed_count + failed_count))
        
        echo ""
        echo "=== TEST SUMMARY ==="
        echo "Total files tested: $total_count"
        echo "Passed: $passed_count"
        echo "Failed: $failed_count"
        echo ""
        
        if [ $failed_count -gt 0 ]; then
          echo "test_failed=true" >> $GITHUB_OUTPUT
          echo "FAILED FILES:"
          grep "^failed" /tmp/all_test_results | cut -d':' -f3
        else
          echo "test_failed=false" >> $GITHUB_OUTPUT
        fi
        
        mkdir -p test_artifacts
        
        mkdir -p test_artifacts/failed_inputs
        grep "^failed" /tmp/all_test_results | cut -d':' -f3 | while read -r f; do
          if [ -f "$f" ]; then
            cp "$f" test_artifacts/failed_inputs/
          fi
        done
        
        mkdir -p test_artifacts/failed_outputs
        grep "^failed" /tmp/all_test_results | cut -d':' -f3 | while read -r f; do
          output_file="${f%.atb}_test.atb"
          if [ -f "$output_file" ]; then
            cp "$output_file" test_artifacts/failed_outputs/
          fi
        done
        
        cp /tmp/all_test_results test_artifacts/results.txt
        
        {
          echo "ATB Test Run Summary"
          echo "===================="
          echo "Date: $(date)"
          echo "Total files: $total_count"
          echo "Passed: $passed_count"
          echo "Failed: $failed_count"
          echo ""
          if [ $failed_count -gt 0 ]; then
            echo "Failed files details:"
            echo "-------------------"
            grep "^failed" /tmp/all_test_results | while read -r line; do
              status=$(echo "$line" | cut -d':' -f1)
              reason=$(echo "$line" | cut -d':' -f2)
              file=$(echo "$line" | cut -d':' -f3)
              echo "- $file: $reason"
            done
          fi
        } > test_artifacts/summary.txt
        
        if [ $failed_count -gt 0 ] && [ -d "test_artifacts/failed_inputs" ]; then
          tar -cJf test_artifacts/failed_inputs.tar.xz -C test_artifacts/failed_inputs .
        fi

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: atb-test-artifacts
        path: test_artifacts/
        retention-days: 7
        
    - name: Check final results
      if: steps.run-tests.outputs.test_failed == 'true'
      run: |
        echo "Some tests failed. Check the 'atb-test-artifacts' artifact for details."
        exit 1